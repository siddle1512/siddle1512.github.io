import{j as e,P as h,G as Se,T as $,B as Ne,r as u,R as Te,H as be,I as D,J as Ee,M as re,w as b,a2 as Le,A as k,K as T,N as Be,O as Re,v as Ve,Q as Ie,S as ze,C as _e,Z as Me,V as We,t as je,W as He}from"./index-98796e33.js";import{u as ge,w as Ge}from"./xlsx-f5126985.js";import{T as q,a as i,b as we,C as De,c as Je,d as ye,e as Ce,f as se,g as Ue}from"./TableSortLabel-9403fd01.js";import{L as Ke}from"./label-8863b2a1.js";import{D as _,a as M,b as W,c as H}from"./DialogTitle-61df68e4.js";import{C as Ye}from"./Container-00550331.js";import{A as ve}from"./Autocomplete-16110deb.js";import"./Close-8a09979b.js";function qe({emptyRows:s,height:c}){return s?e.jsx(q,{sx:{...c&&{height:c*s}},children:e.jsx(i,{colSpan:9})}):null}qe.propTypes={emptyRows:h.number,height:h.number};function Pe({query:s}){return e.jsx(q,{children:e.jsx(i,{align:"center",colSpan:6,sx:{py:3},children:e.jsxs(Se,{sx:{textAlign:"center"},children:[e.jsx($,{variant:"h6",paragraph:!0,children:"Not found"}),e.jsxs($,{variant:"body2",children:["No results found for Â ",e.jsxs("strong",{children:['"',s,'"']}),".",e.jsx("br",{})," Try checking for typos or using complete words."]})]})})})}Pe.propTypes={query:h.string};const Ze={border:0,margin:-1,padding:0,width:"1px",height:"1px",overflow:"hidden",position:"absolute",whiteSpace:"nowrap",clip:"rect(0 0 0 0)"};function Xe(s,c,d){return s?Math.max(0,(1+s)*c-d):0}function ke(s,c,d){const y=d.split(".");let a=s,p=c;for(let x=0;x<y.length;x+=1){const w=y[x];a=a[w],p=p[w]}return a===null?1:p===null||p<a?-1:p>a?1:0}function et(s,c){return s==="desc"?(d,y)=>ke(d,y,c):(d,y)=>-ke(d,y,c)}function tt({inputData:s,comparator:c,filterName:d}){const y=s.map((a,p)=>[a,p]);return y.sort((a,p)=>{const x=c(a[0],p[0]);return x!==0?x:a[1]-p[1]}),s=y.map(a=>a[0]),d&&(s=s.filter(a=>a.customer.name.toLowerCase().indexOf(d.toLowerCase())!==-1)),s}function Qe({order:s,orderBy:c,rowCount:d,headLabel:y,numSelected:a,onRequestSort:p,onSelectAllClick:x}){const w=m=>P=>{p(P,m)};return e.jsx(we,{children:e.jsxs(q,{children:[e.jsx(i,{padding:"checkbox",children:e.jsx(De,{indeterminate:a>0&&a<d,checked:d>0&&a===d,onChange:x})}),y.map(m=>e.jsx(i,{align:m.align||"left",sortDirection:c===m.id?s:!1,sx:{width:m.width,minWidth:m.minWidth},children:e.jsxs(Je,{hideSortIcon:!0,active:c===m.id,direction:c===m.id?s:"asc",onClick:w(m.id),children:[m.label,c===m.id?e.jsx(Ne,{sx:{...Ze},children:s==="desc"?"sorted descending":"sorted ascending"}):null]})},m.id))]})})}Qe.propTypes={order:h.oneOf(["asc","desc"]),orderBy:h.string,rowCount:h.number,headLabel:h.array,numSelected:h.number,onRequestSort:h.func,onSelectAllClick:h.func};function $e({id:s,selected:c,name:d,type:y,price:a,createAt:p,status:x,handleClick:w,updateQuotationStatus:m,fetchQuotations:P}){const[v,G]=u.useState(null);Te();const[ae,ie]=u.useState(!1),[ce,I]=u.useState(!1),[N,R]=u.useState(!1),[J,A]=u.useState(!1),[U,C]=u.useState(null),[F,K]=u.useState(!1),[Q,le]=u.useState(0),de=l=>{ee(l),K(!0)},Y=()=>{K(!1),S()},ue=()=>{ie(!0)},E=()=>{ie(!1),S()},he=()=>{R(!0)},L=()=>{R(!1),S()},pe=()=>{I(!0)},V=()=>{I(!1),S()},Z=l=>{G(l.currentTarget)},S=()=>{G(null)},xe=async l=>{try{const j=localStorage.getItem("jwttoken");(await fetch(`${k}/api/Quotation/${l}/confirm`,{method:"PUT",headers:{Authorization:`Bearer ${j}`,"Content-Type":"application/json"}})).ok?(console.log("Quotation confirmed successfully."),m(l,"To Invoice"),P(),L(),S(),T.fire({title:"Confirmed!",text:"Confirm quotation successfully!",icon:"success"})):(console.error("Failed to confirm quotation."),S(),T.fire({icon:"error",title:"Failed!",text:"Failed to confirm quotation!"}))}catch(j){console.error("Error confirming quotation:",j)}},X=async l=>{try{const j=localStorage.getItem("jwttoken");(await fetch(`${k}/api/Quotation/${l}/cancel`,{method:"PUT",headers:{Authorization:`Bearer ${j}`,"Content-Type":"application/json"}})).ok?(console.log("Quotation canceled successfully."),m(l,"Cancelled"),P(),V(),S(),T.fire({title:"Canceled!",text:"Cancel quotation successfully!",icon:"success"})):(console.error("Failed to cancel quotation."),S(),T.fire({icon:"error",title:"Failed!",text:"Failed to cancel quotation!"}))}catch(j){console.error("Error canceling quotation:",j)}},ee=async l=>{try{const j=localStorage.getItem("jwttoken"),O=await fetch(`${k}/api/Quotation/${l}`,{headers:{Authorization:`Bearer ${j}`}});if(O.ok){const te=await O.json();C(te);const fe=te.reduce((oe,me)=>oe+me.subTotal,0);le(fe)}else console.error("Failed to fetch quotation details")}catch(j){throw console.error("Error fetching quotation details:",j),j}},B=async l=>{try{A(!0);const j=localStorage.getItem("jwttoken");(await fetch(`${k}/api/Quotation/${l}/SendQuotationEmail`,{method:"POST",headers:{Authorization:`Bearer ${j}`,"Content-Type":"application/json"},body:JSON.stringify({quotationId:l})})).ok?(console.log("Quotation email sent successfully."),A(!1),E(),S(),T.fire({title:"Email Sent!",text:"Quotation email sent successfully!",icon:"success"})):(console.error("Failed to send quotation email."),E(),S(),T.fire({icon:"error",title:"Failed!",text:"Failed to send quotation email!"}))}catch(j){console.error("Error sending quotation email:",j)}};return e.jsxs(e.Fragment,{children:[e.jsxs(q,{hover:!0,tabIndex:-1,role:"checkbox",selected:c,children:[e.jsx(i,{padding:"checkbox",children:e.jsx(De,{disableRipple:!0,checked:c,onChange:w})}),e.jsx(i,{children:e.jsx($,{variant:"subtitle2",noWrap:!0,children:d})}),e.jsx(i,{children:(()=>{let l="primary",j=x;return x==="Cancelled"?l="error":x==="To Invoice"||x==="Fully Invoice"?(l="success",j="order"):l="primary",e.jsx(Ke,{color:l,children:j})})()}),e.jsx(i,{children:ot(p)}),e.jsx(i,{children:a.toLocaleString("vi-VN",{style:"currency",currency:"VND"})}),e.jsx(i,{align:"right",children:e.jsx(be,{onClick:Z,children:e.jsx(D,{icon:"eva:more-vertical-fill"})})})]}),e.jsxs(Ee,{open:!!v,anchorEl:v,onClose:S,anchorOrigin:{vertical:"top",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"right"},PaperProps:{sx:{width:140}},children:[e.jsxs(re,{onClick:()=>de(s),sx:{color:"warning.main"},children:[e.jsx(D,{icon:"eva-info-fill",sx:{mr:2}}),"Detail"]}),e.jsxs(_,{open:F,onClose:Y,children:[e.jsx(M,{children:"Quotation Detail"}),e.jsx(W,{children:U&&e.jsx(e.Fragment,{children:e.jsx(ye,{component:Se,children:e.jsxs(Ce,{children:[e.jsx(we,{children:e.jsxs(q,{children:[e.jsx(i,{children:"Product"}),e.jsx(i,{children:"Quantity"}),e.jsx(i,{children:"SubTotal"}),e.jsx(i,{children:"Tax"})]})}),e.jsx(se,{children:U.map(l=>e.jsxs(q,{children:[e.jsx(i,{children:l.product.name}),e.jsx(i,{children:l.quantity}),e.jsx(i,{children:l.subTotal.toLocaleString("vi-VN",{style:"currency",currency:"VND"})}),e.jsxs(i,{children:[l.product.tax*100,"%"]})]},l.id))}),e.jsx(se,{children:e.jsxs(q,{children:[e.jsx(i,{colSpan:2,className:"text-right",children:e.jsx($,{variant:"strong",children:"Total:"})}),e.jsx(i,{children:Q.toLocaleString("vi-VN",{style:"currency",currency:"VND"})})]})})]})})})}),e.jsx(H,{children:e.jsx(b,{onClick:Y,variant:"outlined",color:"primary",children:"Close"})})]}),x==="Quotation"&&e.jsxs(re,{onClick:he,sx:{color:"success.main"},children:[e.jsx(D,{icon:"eva:edit-fill",sx:{mr:2}}),"Confirm"]}),e.jsxs(_,{open:N,onClose:L,children:[e.jsx(M,{children:"Confirm"}),e.jsx(W,{children:"Are you sure you want to confirm this quotation?"}),e.jsxs(H,{children:[e.jsx(b,{onClick:L,variant:"outlined",color:"primary",children:"Leave"}),e.jsx(b,{onClick:()=>xe(s),variant:"contained",color:"success",children:"Confirm"})]})]}),x==="Quotation"&&e.jsxs(re,{onClick:ue,sx:{color:"primary.main"},children:[e.jsx(D,{icon:"eva-navigation-2-fill",sx:{mr:2}}),"Send"]}),e.jsxs(_,{open:ae,onClose:E,children:[e.jsx(M,{children:"Send"}),e.jsx(W,{children:"Are you sure you want to send this quotation?"}),e.jsxs(H,{children:[e.jsx(b,{onClick:E,variant:"outlined",color:"primary",children:"Leave"}),e.jsxs(b,{onClick:()=>B(s),variant:"contained",color:"primary",disabled:J,children:[J&&e.jsx(Le,{size:24,sx:{position:"absolute",left:"50%",top:"50%",marginLeft:"-12px",marginTop:"-12px"}}),"Send"]})]})]}),x==="Quotation"&&e.jsxs(re,{onClick:pe,sx:{color:"error.main"},children:[e.jsx(D,{icon:"eva-close-square-outline",sx:{mr:2}}),"Cancel"]}),e.jsxs(_,{open:ce,onClose:V,children:[e.jsx(M,{children:"Cancel"}),e.jsx(W,{children:"Are you sure you want to cancel this quotation?"}),e.jsxs(H,{children:[e.jsx(b,{onClick:V,variant:"outlined",color:"primary",children:"Leave"}),e.jsx(b,{onClick:()=>X(s),variant:"contained",color:"error",children:"Cancel"})]})]})]})]})}$e.propTypes={id:h.number,selected:h.bool,name:h.string,type:h.string,price:h.number,createAt:h.string,status:h.string,handleClick:h.func,updateQuotationStatus:h.func,fetchQuotations:h.func};function ot(s){const c=new Date(s),d=c.getDate(),y=c.getMonth()+1,a=c.getFullYear(),p=c.getHours(),x=c.getMinutes(),w=d<10?`0${d}`:d,m=y<10?`0${y}`:y,P=p<10?`0${p}`:p,v=x<10?`0${x}`:x;return`${w}/${m}/${a} (${P}:${v})`}function Ae({numSelected:s,filterName:c,onFilterName:d,onDelete:y,onExportToExcel:a}){return u.useState(!1),e.jsxs(Be,{sx:{height:96,display:"flex",justifyContent:"space-between",p:p=>p.spacing(0,1,0,3),...s>0&&{color:"primary.main",bgcolor:"primary.lighter"}},children:[s>0?e.jsxs($,{component:"div",variant:"subtitle1",children:[s," selected"]}):e.jsx(Re,{value:c,onChange:d,placeholder:"Search Quotaion...",startAdornment:e.jsx(Ve,{position:"start",children:e.jsx(D,{icon:"eva:search-fill",sx:{color:"text.disabled",width:20,height:20}})})}),s>0&&e.jsx(Ie,{title:"Export to Excel",children:e.jsx(be,{onClick:a,children:e.jsx(D,{icon:"eva-save-fill"})})})]})}Ae.propTypes={numSelected:h.number,filterName:h.string,onFilterName:h.func,onDelete:h.func,onExportToExcel:h.func.isRequired};function nt(){const[s,c]=u.useState(0),[d,y]=u.useState("asc"),[a,p]=u.useState([]),[x,w]=u.useState("name"),[m,P]=u.useState(""),[v,G]=u.useState(5),ae=Te();u.useRef(!0);const[ie,ce]=u.useState(!1),[I,N]=u.useState([]),[R,J]=u.useState([]),[A,U]=u.useState([]);u.useState(!1);const[C,F]=u.useState({customerId:"",products:[{productId:"",quantity:1,subtotal:0}]}),[K,Q]=u.useState(!1);u.useState(null),u.useState(0),u.useEffect(()=>{const t=async()=>{try{const r=localStorage.getItem("jwttoken"),f=await fetch(`${k}/api/Quotation`,{headers:{Authorization:`Bearer ${r}`}});if(f.ok){const g=await f.json();console.log(g),N(g)}else console.error("Failed to fetch quotations")}catch(r){console.error("Error fetching quotations:",r)}},n=async()=>{try{const r=localStorage.getItem("jwttoken"),f=await fetch(`${k}/api/Customer/GetCustomer`,{headers:{Authorization:`Bearer ${r}`}});if(f.ok){const g=await f.json();console.log(g),J(g)}else console.error("Failed to fetch customers")}catch(r){console.error("Error fetching customers:",r)}},o=async()=>{try{const r=localStorage.getItem("jwttoken"),f=await fetch(`${k}/api/Product`,{headers:{Authorization:`Bearer ${r}`}});if(f.ok){const g=await f.json();console.log(g),U(g)}else console.error("Failed to fetch products")}catch(r){console.error("Error fetching products:",r)}};t(),n(),o()},[ae]);const le=(t,n)=>{n!==""&&(y(x===n&&d==="asc"?"desc":"asc"),w(n))},de=t=>{if(t.target.checked){const n=I.map(o=>o.id);p(n);return}p([])},Y=(t,n)=>{const o=a.indexOf(n);let r=[];o===-1?r=r.concat(a,n):o===0?r=r.concat(a.slice(1)):o===a.length-1?r=r.concat(a.slice(0,-1)):o>0&&(r=r.concat(a.slice(0,o),a.slice(o+1))),p(r)},ue=(t,n)=>{c(n)},E=t=>{c(0),G(parseInt(t.target.value,10))},he=t=>{c(0),P(t.target.value)},L=tt({inputData:I,comparator:et(d,x),filterName:m}),pe=!L.length&&!!m,V=(t,n)=>{N(o=>o.map(r=>r.id===t?{...r,status:n}:r))},Z=async()=>{try{const t=localStorage.getItem("jwttoken"),n=await fetch(`${k}/api/Quotation`,{headers:{Authorization:`Bearer ${t}`}});if(n.ok){const o=await n.json();console.log(o),N(o)}else console.error("Failed to fetch quotations")}catch(t){console.error("Error fetching quotations:",t)}},S=async()=>{if(!C.customerId||!C.products.some(o=>o.productId)){console.error("Invalid quotation. CustomerId and at least one product are required."),Q(!1),T.fire({icon:"error",title:"Oops...",text:"Invalid quotation!"});return}const t=new Set;if(C.products.some(o=>t.has(o.productId)?!0:(t.add(o.productId),!1))){console.error("Invalid quotation. Duplicate products are not allowed."),Q(!1),T.fire({icon:"error",title:"Oops...",text:"Duplicate products are not allowed!"});return}try{const o=localStorage.getItem("jwttoken"),r=await fetch(`${k}/api/Quotation`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({customerId:C.customerId,products:C.products})});if(r.ok){const f=await r.json();N(g=>[...g,f]),Z(),Q(!1),T.fire({title:"Added!",text:"Addquotation successfully!",icon:"success"})}else{const f=await r.text();console.error("Failed to create quotation:",f),Q(!1),T.fire({icon:"error",title:"Oops...",text:"Failed to create quotation!"})}}catch(o){console.error("Error creating quotation:",o)}F({customerId:"",products:[{productId:"",quantity:1}]}),ce(!1)},xe=()=>{Q(!0)},X=()=>{Q(!1)},ee=(t,n)=>{const o=B(t);return(n*o).toLocaleString("vi-VN",{style:"currency",currency:"VND"})},B=t=>{const n=A.find(o=>o.id===t);return n?n.price:0},l=t=>{F(n=>{const o=[...n.products];return o.splice(t,1),{...n,products:o}})},j=(t,n,o)=>{F(r=>{const f=r.products.map((g,z)=>z===t?{...g,[n]:o,subtotal:ee(g.productId,o)}:g);return{...r,products:f}})},O=()=>{F(t=>({...t,products:[...t.products,{productId:"",quantity:1,subtotal:0}]}))},te=()=>C.products.reduce((n,o)=>{const f=B(o.productId)*o.quantity;return n+f},0).toLocaleString("vi-VN",{style:"currency",currency:"VND"}),fe=()=>C.products.reduce((n,o)=>{const r=B(o.productId),f=oe(o.productId),g=r*(1+f)*o.quantity;return n+g},0).toLocaleString("vi-VN",{style:"currency",currency:"VND"}),oe=t=>{const n=A.find(o=>o.id===t);return n?n.tax:0},me=async()=>{const t=ge.book_new(),n=[];await Promise.all(a.map(async r=>{const f=I.find(z=>z.id===r),g=await Fe(r);if(f&&g&&g.length>0){const z={Customer:f.customer.name,Status:f.status,CreateAt:f.createdAt,Total:f.total},Oe=g.map(ne=>({Product:ne.product.name,Quantity:ne.quantity,Subtotal:ne.subTotal,Tax:ne.product.tax}));n.push(z,...Oe)}else console.error(`Failed to fetch quotation details for ID ${r}`)}));const o=ge.json_to_sheet(n);ge.book_append_sheet(t,o,"Quotations_With_Details"),Ge(t,"selected_quotations_with_details.xlsx")},Fe=async t=>{try{const n=localStorage.getItem("jwttoken"),o=await fetch(`${k}/api/Quotation/${t}`,{headers:{Authorization:`Bearer ${n}`}});if(o.ok)return await o.json();console.error(`Failed to fetch quotation details for ID ${t}`)}catch(n){console.error("Error fetching quotation details:",n)}return[]};return e.jsxs(Ye,{children:[e.jsxs(ze,{direction:"row",alignItems:"center",justifyContent:"space-between",mb:5,children:[e.jsx($,{variant:"h4",children:"Quotations"}),e.jsx(b,{onClick:xe,variant:"contained",color:"inherit",startIcon:e.jsx(D,{icon:"eva:plus-fill"}),children:"New Quotation"})]}),e.jsxs(_e,{children:[e.jsx(Ae,{numSelected:a.length,filterName:m,onFilterName:he,onExportToExcel:me}),e.jsx(Me,{children:e.jsx(ye,{sx:{overflow:"unset"},children:e.jsxs(Ce,{sx:{minWidth:800},children:[e.jsx(Qe,{order:d,orderBy:x,rowCount:I.length,numSelected:a.length,onRequestSort:le,onSelectAllClick:de,headLabel:[{id:"customer.name",label:"Customer"},{id:"status",label:"Status"},{id:"createAt",label:"CreateAt"},{id:"price",label:"Total($)"},{id:""}]}),e.jsxs(se,{children:[L.slice(s*v,s*v+v).map(t=>e.jsx($e,{id:t.id,name:t.customer.name,status:t.status,createAt:t.createdAt,price:t.total,updateQuotationStatus:V,selected:a.indexOf(t.id)!==-1,handleClick:n=>Y(n,t.id),fetchQuotations:Z},t.id)),e.jsx(qe,{height:77,emptyRows:Xe(s,v,I.length)}),pe&&e.jsx(Pe,{query:m})]})]})})}),e.jsx(Ue,{page:s,component:"div",count:I.length,rowsPerPage:v,onPageChange:ue,rowsPerPageOptions:[5,10,25],onRowsPerPageChange:E})]}),e.jsxs(_,{open:K,onClose:X,maxWidth:"md",fullWidth:!0,children:[e.jsx(M,{children:"Create Quotation"}),e.jsxs(W,{children:[e.jsx(We,{fullWidth:!0,variant:"outlined",margin:"dense",children:e.jsx(ve,{options:R,getOptionLabel:t=>t.name,value:C.customerId?R.find(t=>t.id===C.customerId):null,onChange:(t,n)=>{F({...C,customerId:n?n.id:""})},renderInput:t=>e.jsx(je,{...t,label:"Customer",variant:"outlined"})})}),e.jsx(ye,{component:Se,style:{marginTop:"16px"},children:e.jsxs(Ce,{children:[e.jsx(we,{children:e.jsxs(q,{children:[e.jsx(i,{children:"Product"}),e.jsx(i,{children:"Price($)"}),e.jsx(i,{children:"Quantity"}),e.jsx(i,{children:"SubTotal($)"}),e.jsx(i,{children:"Tax"}),e.jsx(i,{children:"Action"})]})}),e.jsx(se,{children:C.products.map((t,n)=>e.jsxs(q,{children:[e.jsx(i,{children:e.jsx(ve,{options:A,getOptionLabel:o=>o.name,value:t.productId?A.find(o=>o.id===t.productId):null,onChange:(o,r)=>{j(n,"productId",r?r.id:"")},renderInput:o=>e.jsx(je,{...o,label:"Product",variant:"outlined"})})}),e.jsx(i,{children:`${B(t.productId).toLocaleString("vi-VN",{style:"currency",currency:"VND"})}`}),e.jsx(i,{children:e.jsx(je,{type:"number",min:"1",value:t.quantity,onChange:o=>j(n,"quantity",o.target.value),variant:"outlined",style:{width:"80px"}})}),e.jsx(i,{children:`${ee(t.productId,t.quantity)}`}),e.jsx(i,{children:`${oe(t.productId)*100}%`}),e.jsx(i,{onClick:()=>l(n),children:e.jsx(Ie,{title:"Cancel",children:e.jsx(be,{children:e.jsx(D,{icon:"eva-close-fill"})})})})]},n))})]})}),e.jsx(b,{variant:"outlined",color:"primary",onClick:O,style:{marginTop:"8px"},children:"More"})]}),e.jsxs(H,{children:[e.jsxs("div",{style:{flexGrow:1,marginLeft:"16px"},children:[e.jsx($,{variant:"body1",children:`Total without tax: ${te()}`}),e.jsx($,{variant:"body1",children:`Total with tax: ${fe()}`})]}),e.jsx(b,{onClick:X,variant:"outlined",color:"primary",children:"Cancel"}),e.jsx(b,{variant:"contained",color:"success",onClick:S,children:"Add"})]})]})]})}function ht(){return e.jsxs(e.Fragment,{children:[e.jsx(He,{children:e.jsx("title",{children:" Quotations | SaleBook "})}),e.jsx(nt,{})]})}export{ht as default};
